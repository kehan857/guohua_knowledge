// ç†µå˜æ™ºå…ƒAIé”€å”®åŠ©æ‰‹ Jenkins CI/CD æµæ°´çº¿

pipeline {
    agent any
    
    // ç¯å¢ƒå˜é‡
    environment {
        // é¡¹ç›®é…ç½®
        PROJECT_NAME = 'ai-sales-assistant'
        IMAGE_NAME = 'ai-sales-assistant'
        
        // Docker Registry
        DOCKER_REGISTRY = credentials('docker-registry-url')
        DOCKER_CREDENTIALS = credentials('docker-registry-credentials')
        
        // Kubernetesé…ç½®
        K8S_NAMESPACE = 'ai-sales-assistant'
        K8S_CREDENTIALS = credentials('k8s-credentials')
        
        // é€šçŸ¥é…ç½®
        SLACK_CHANNEL = '#devops'
        EMAIL_RECIPIENTS = 'devops@yourcompany.com'
        
        // ç‰ˆæœ¬å·
        VERSION = "${BUILD_NUMBER}"
        GIT_COMMIT_SHORT = "${GIT_COMMIT[0..7]}"
    }
    
    // æ„å»ºå‚æ•°
    parameters {
        choice(
            name: 'DEPLOY_ENVIRONMENT',
            choices: ['dev', 'staging', 'production'],
            description: 'éƒ¨ç½²ç¯å¢ƒ'
        )
        booleanParam(
            name: 'SKIP_TESTS',
            defaultValue: false,
            description: 'è·³è¿‡æµ‹è¯•'
        )
        booleanParam(
            name: 'FORCE_DEPLOY',
            defaultValue: false,
            description: 'å¼ºåˆ¶éƒ¨ç½²'
        )
        string(
            name: 'GIT_BRANCH',
            defaultValue: 'main',
            description: 'Gitåˆ†æ”¯'
        )
    }
    
    // æ„å»ºè§¦å‘å™¨
    triggers {
        // å®šæ—¶æ„å»º (æ¯å¤©å‡Œæ™¨2ç‚¹)
        cron('0 2 * * *')
        
        // Gitæäº¤è§¦å‘
        githubPush()
    }
    
    // æ„å»ºé€‰é¡¹
    options {
        // æ„å»ºå†å²ä¿ç•™
        buildDiscarder(logRotator(
            numToKeepStr: '50',
            artifactNumToKeepStr: '20'
        ))
        
        // è¶…æ—¶è®¾ç½®
        timeout(time: 60, unit: 'MINUTES')
        
        // å¹¶å‘æ„å»ºæ§åˆ¶
        disableConcurrentBuilds()
        
        // æ—¶é—´æˆ³
        timestamps()
    }
    
    stages {
        // 1. å‡†å¤‡é˜¶æ®µ
        stage('Preparation') {
            steps {
                script {
                    // æ‰“å°ç¯å¢ƒä¿¡æ¯
                    echo "ğŸš€ å¼€å§‹æ„å»º ${PROJECT_NAME}"
                    echo "ğŸ“ åˆ†æ”¯: ${params.GIT_BRANCH}"
                    echo "ğŸ”¢ ç‰ˆæœ¬: ${VERSION}"
                    echo "ğŸŒ ç¯å¢ƒ: ${params.DEPLOY_ENVIRONMENT}"
                    echo "ğŸ’¾ Gitæäº¤: ${GIT_COMMIT_SHORT}"
                    
                    // è®¾ç½®æ„å»ºæè¿°
                    currentBuild.description = "v${VERSION} - ${params.DEPLOY_ENVIRONMENT}"
                }
                
                // æ¸…ç†å·¥ä½œç©ºé—´
                cleanWs()
                
                // æ£€å‡ºä»£ç 
                checkout([
                    $class: 'GitSCM',
                    branches: [[name: "*/${params.GIT_BRANCH}"]],
                    doGenerateSubmoduleConfigurations: false,
                    extensions: [
                        [$class: 'CloneOption', depth: 1, noTags: false, reference: '', shallow: true]
                    ],
                    submoduleCfg: [],
                    userRemoteConfigs: [[
                        credentialsId: 'git-credentials',
                        url: 'https://github.com/yourcompany/ai-sales-assistant.git'
                    ]]
                ])
                
                // å®‰è£…ä¾èµ–å·¥å…·
                sh '''
                    echo "ğŸ“¦ å®‰è£…æ„å»ºä¾èµ–..."
                    python3 -m pip install --upgrade pip
                    pip install -r fastapi-backend/requirements.txt
                '''
            }
        }
        
        // 2. ä»£ç è´¨é‡æ£€æŸ¥
        stage('Code Quality') {
            parallel {
                // é™æ€ä»£ç åˆ†æ
                stage('Static Analysis') {
                    steps {
                        script {
                            echo "ğŸ” æ‰§è¡Œé™æ€ä»£ç åˆ†æ..."
                            sh '''
                                # Pythonä»£ç æ£€æŸ¥
                                flake8 fastapi-backend --max-line-length=120 --ignore=E203,W503
                                
                                # å®‰å…¨æ£€æŸ¥
                                bandit -r fastapi-backend -f json -o bandit-report.json || true
                                
                                # ä¾èµ–å®‰å…¨æ£€æŸ¥
                                safety check --json --output safety-report.json || true
                            '''
                        }
                    }
                    post {
                        always {
                            // å‘å¸ƒæŠ¥å‘Š
                            recordIssues(
                                enabledForFailure: true,
                                tools: [
                                    flake8(pattern: 'flake8.log'),
                                    pyLint(pattern: 'pylint.log')
                                ]
                            )
                        }
                    }
                }
                
                // ç±»å‹æ£€æŸ¥
                stage('Type Check') {
                    steps {
                        script {
                            echo "ğŸ” æ‰§è¡Œç±»å‹æ£€æŸ¥..."
                            sh '''
                                cd fastapi-backend
                                mypy . --ignore-missing-imports --html-report mypy-report
                            '''
                        }
                    }
                }
            }
        }
        
        // 3. å•å…ƒæµ‹è¯•
        stage('Unit Tests') {
            when {
                not { params.SKIP_TESTS }
            }
            steps {
                script {
                    echo "ğŸ§ª æ‰§è¡Œå•å…ƒæµ‹è¯•..."
                    sh '''
                        cd fastapi-backend
                        
                        # è®¾ç½®æµ‹è¯•ç¯å¢ƒ
                        export TESTING=true
                        export DATABASE_URL="sqlite:///./test.db"
                        
                        # è¿è¡Œæµ‹è¯•
                        python -m pytest tests/ \
                            --junitxml=test-results.xml \
                            --cov=app \
                            --cov-report=xml \
                            --cov-report=html \
                            -v
                    '''
                }
            }
            post {
                always {
                    // å‘å¸ƒæµ‹è¯•ç»“æœ
                    publishTestResults(
                        testResultsPattern: 'fastapi-backend/test-results.xml'
                    )
                    
                    // å‘å¸ƒè¦†ç›–ç‡æŠ¥å‘Š
                    publishCoverage(
                        adapters: [
                            coberturaAdapter('fastapi-backend/coverage.xml')
                        ],
                        sourceFileResolver: sourceFiles('STORE_LAST_BUILD')
                    )
                }
            }
        }
        
        // 4. é›†æˆæµ‹è¯•
        stage('Integration Tests') {
            when {
                not { params.SKIP_TESTS }
            }
            steps {
                script {
                    echo "ğŸ”— æ‰§è¡Œé›†æˆæµ‹è¯•..."
                    sh '''
                        # å¯åŠ¨æµ‹è¯•ç¯å¢ƒ
                        docker-compose -f infrastructure/docker/docker-compose.test.yml up -d
                        
                        # ç­‰å¾…æœåŠ¡å¯åŠ¨
                        sleep 30
                        
                        # æ‰§è¡Œé›†æˆæµ‹è¯•
                        python -m pytest tests/integration/ -v
                        
                        # æ¸…ç†æµ‹è¯•ç¯å¢ƒ
                        docker-compose -f infrastructure/docker/docker-compose.test.yml down
                    '''
                }
            }
        }
        
        // 5. å®‰å…¨æ‰«æ
        stage('Security Scan') {
            parallel {
                // å®¹å™¨å®‰å…¨æ‰«æ
                stage('Container Scan') {
                    steps {
                        script {
                            echo "ğŸ”’ æ‰§è¡Œå®¹å™¨å®‰å…¨æ‰«æ..."
                            sh '''
                                # æ„å»ºæµ‹è¯•é•œåƒ
                                docker build -f infrastructure/docker/Dockerfile -t ${IMAGE_NAME}:security-scan fastapi-backend/
                                
                                # å®¹å™¨å®‰å…¨æ‰«æ
                                trivy image --format json --output trivy-report.json ${IMAGE_NAME}:security-scan || true
                            '''
                        }
                    }
                }
                
                // ä»£ç å®‰å…¨æ‰«æ
                stage('Code Scan') {
                    steps {
                        script {
                            echo "ğŸ”’ æ‰§è¡Œä»£ç å®‰å…¨æ‰«æ..."
                            sh '''
                                # SonarQubeæ‰«æ
                                sonar-scanner \
                                    -Dsonar.projectKey=${PROJECT_NAME} \
                                    -Dsonar.sources=fastapi-backend \
                                    -Dsonar.host.url=${SONAR_HOST_URL} \
                                    -Dsonar.login=${SONAR_AUTH_TOKEN}
                            '''
                        }
                    }
                }
            }
        }
        
        // 6. æ„å»ºé•œåƒ
        stage('Build Image') {
            steps {
                script {
                    echo "ğŸ—ï¸ æ„å»ºDockeré•œåƒ..."
                    
                    // æ„å»ºé•œåƒ
                    def image = docker.build(
                        "${DOCKER_REGISTRY}/${IMAGE_NAME}:${VERSION}",
                        "-f infrastructure/docker/Dockerfile fastapi-backend/"
                    )
                    
                    // æ ‡è®°é•œåƒ
                    image.tag("${VERSION}")
                    image.tag("latest")
                    image.tag("${params.DEPLOY_ENVIRONMENT}")
                    
                    // æ¨é€é•œåƒ
                    docker.withRegistry("https://${DOCKER_REGISTRY}", "${DOCKER_CREDENTIALS}") {
                        image.push("${VERSION}")
                        image.push("latest")
                        image.push("${params.DEPLOY_ENVIRONMENT}")
                    }
                    
                    echo "âœ… é•œåƒæ„å»ºå¹¶æ¨é€å®Œæˆ: ${DOCKER_REGISTRY}/${IMAGE_NAME}:${VERSION}"
                }
            }
        }
        
        // 7. éƒ¨ç½²
        stage('Deploy') {
            when {
                anyOf {
                    environment name: 'DEPLOY_ENVIRONMENT', value: 'dev'
                    environment name: 'DEPLOY_ENVIRONMENT', value: 'staging'
                    allOf {
                        environment name: 'DEPLOY_ENVIRONMENT', value: 'production'
                        anyOf {
                            params.FORCE_DEPLOY
                            branch 'main'
                        }
                    }
                }
            }
            steps {
                script {
                    echo "ğŸš€ éƒ¨ç½²åˆ° ${params.DEPLOY_ENVIRONMENT} ç¯å¢ƒ..."
                    
                    // æ ¹æ®ç¯å¢ƒé€‰æ‹©éƒ¨ç½²æ–¹å¼
                    if (params.DEPLOY_ENVIRONMENT == 'dev') {
                        deployToDev()
                    } else if (params.DEPLOY_ENVIRONMENT == 'staging') {
                        deployToStaging()
                    } else if (params.DEPLOY_ENVIRONMENT == 'production') {
                        deployToProduction()
                    }
                }
            }
        }
        
        // 8. éƒ¨ç½²éªŒè¯
        stage('Deployment Verification') {
            steps {
                script {
                    echo "âœ… éªŒè¯éƒ¨ç½²çŠ¶æ€..."
                    
                    // å¥åº·æ£€æŸ¥
                    def healthCheckUrl = getHealthCheckUrl(params.DEPLOY_ENVIRONMENT)
                    
                    retry(5) {
                        sleep(30)
                        sh """
                            curl -f ${healthCheckUrl}/health || exit 1
                        """
                    }
                    
                    echo "âœ… éƒ¨ç½²éªŒè¯æˆåŠŸ"
                }
            }
        }
        
        // 9. æ€§èƒ½æµ‹è¯•
        stage('Performance Test') {
            when {
                environment name: 'DEPLOY_ENVIRONMENT', value: 'staging'
            }
            steps {
                script {
                    echo "âš¡ æ‰§è¡Œæ€§èƒ½æµ‹è¯•..."
                    sh '''
                        # ä½¿ç”¨K6è¿›è¡Œæ€§èƒ½æµ‹è¯•
                        k6 run tests/performance/load-test.js
                    '''
                }
            }
        }
    }
    
    // æ„å»ºåæ“ä½œ
    post {
        always {
            script {
                echo "ğŸ§¹ æ‰§è¡Œæ¸…ç†æ“ä½œ..."
                
                // æ¸…ç†Dockeré•œåƒ
                sh '''
                    docker image prune -f
                    docker container prune -f
                '''
                
                // å½’æ¡£æ„ä»¶
                archiveArtifacts(
                    artifacts: '**/*.xml,**/*.json,**/*.html',
                    allowEmptyArchive: true
                )
            }
        }
        
        success {
            script {
                echo "âœ… æ„å»ºæˆåŠŸï¼"
                
                // å‘é€æˆåŠŸé€šçŸ¥
                sendNotification(
                    'success',
                    "âœ… ${PROJECT_NAME} v${VERSION} æ„å»ºæˆåŠŸ",
                    "åˆ†æ”¯: ${params.GIT_BRANCH}\nç¯å¢ƒ: ${params.DEPLOY_ENVIRONMENT}\næäº¤: ${GIT_COMMIT_SHORT}"
                )
            }
        }
        
        failure {
            script {
                echo "âŒ æ„å»ºå¤±è´¥ï¼"
                
                // å‘é€å¤±è´¥é€šçŸ¥
                sendNotification(
                    'failure',
                    "âŒ ${PROJECT_NAME} v${VERSION} æ„å»ºå¤±è´¥",
                    "åˆ†æ”¯: ${params.GIT_BRANCH}\nç¯å¢ƒ: ${params.DEPLOY_ENVIRONMENT}\næäº¤: ${GIT_COMMIT_SHORT}\né”™è¯¯: ${currentBuild.description}"
                )
            }
        }
        
        unstable {
            script {
                echo "âš ï¸ æ„å»ºä¸ç¨³å®šï¼"
                
                // å‘é€è­¦å‘Šé€šçŸ¥
                sendNotification(
                    'warning',
                    "âš ï¸ ${PROJECT_NAME} v${VERSION} æ„å»ºä¸ç¨³å®š",
                    "åˆ†æ”¯: ${params.GIT_BRANCH}\nç¯å¢ƒ: ${params.DEPLOY_ENVIRONMENT}\næäº¤: ${GIT_COMMIT_SHORT}"
                )
            }
        }
    }
}

// è‡ªå®šä¹‰å‡½æ•°
def deployToDev() {
    sh '''
        echo "éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ..."
        ./infrastructure/scripts/deploy.sh docker -e .env.dev --skip-migrate
    '''
}

def deployToStaging() {
    sh '''
        echo "éƒ¨ç½²åˆ°é¢„å‘å¸ƒç¯å¢ƒ..."
        ./infrastructure/scripts/deploy.sh k8s -n ai-sales-assistant-staging -v ${VERSION}
    '''
}

def deployToProduction() {
    // éœ€è¦äººå·¥ç¡®è®¤
    input(
        message: "ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼Ÿ",
        parameters: [
            booleanParam(
                name: 'CONFIRM_PRODUCTION_DEPLOY',
                defaultValue: false,
                description: 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ'
            )
        ]
    )
    
    sh '''
        echo "éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
        ./infrastructure/scripts/deploy.sh k8s -n ai-sales-assistant -v ${VERSION}
    '''
}

def getHealthCheckUrl(environment) {
    def urls = [
        'dev': 'http://localhost:8000',
        'staging': 'https://staging-api.yourdomain.com',
        'production': 'https://api.yourdomain.com'
    ]
    return urls[environment]
}

def sendNotification(type, title, message) {
    // Slacké€šçŸ¥
    if (env.SLACK_WEBHOOK_URL) {
        def colors = [
            'success': 'good',
            'failure': 'danger',
            'warning': 'warning'
        ]
        
        slackSend(
            channel: "${SLACK_CHANNEL}",
            color: colors[type],
            message: "${title}\n${message}"
        )
    }
    
    // é‚®ä»¶é€šçŸ¥
    if (type == 'failure') {
        emailext(
            subject: "${title}",
            body: "${message}",
            to: "${EMAIL_RECIPIENTS}"
        )
    }
}

